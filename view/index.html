{% extends 'layout.html' %}
{% block body %}
<div class="container-wide" ng-controller="homeCtrl">
	<form ng-submit="login()" id="loginForm">
    <p>
      <label>Username:
        <input type="text" name="username" value="test" />
      </label>
    </p>
    <p>
      <label>Password:
        <input type="password" name="password" value="test" />
      </label>
    </p>
    <p>
      <button type="submit">Log In</button>
    </p>
    <p>
      <a href="/auth/facebook">Sign in with Facebook</a> <a href="/auth/twitter">Sign in with Twitter</a> <a href="/auth/google">Sign in with Google</a>
    </p>
  </form>

	<h1>HELLO WORLD!</h1>
	<div ng-repeat="item in project">
		[[item]]
	</div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
var createGuid = function() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
               .toString(16)
               .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
           s4() + '-' + s4() + s4() + s4();

};

var createOrGetGuestId = function(){
  return $.Deferred(function( defer ) {
    //delete localStorage.guestId
    if(localStorage.guestId){
      defer.resolve(localStorage.guestId)
    }else{
      localStorage.guestId = createGuid()
      $.ajax({type: "POST", url: "/api/user", data: {guestId: localStorage.guestId}})
      .then(function(resp){

        defer.resolve(localStorage.guestId)
      })
    }
  })
}



function homeCtrl($scope, $http) {
	$scope.project = ["Hello", "World", "!"];
  createOrGetGuestId().then(function(id){
    console.log(id)
  })

  $scope.login = function(){
    // console.log("hit")
    //method="post" action="/login"
    $.ajax({type: "POST", url: "/login", data: decodeURIComponent($.param({username: localStorage.guestId, password: "test"})),success: function(resp) {
            window.location = resp.data;
        },
        error: function(resp) {
            window.location = resp.data;
        }})

  }
}
</script>
{% endblock %}